{% block ylistitems %}

    {% load static %}
    {% load i18n %}

    <div id="ajax_itemsresult">

        <div id="listslist" style="padding:0px 0px 0px 10px;">

            <div class="object-list-filters">
                <div id="myMenu">

                </div>
                <div id="myCell" style="display: none">
                    <form action="" method="POST" id="form_cell">
                        {% csrf_token %}
                        {#                    <input type="text" name="inputCellName" id="inputCell" placeholder="{% trans 'Введите значение' %}" autofocus>#}
                        <textarea class="form-control" name="inputCellName" id="inputCell" placeholder="{% trans 'Введите значение' %}"
                                  autofocus></textarea>
                        <input type="submit" id="myCellButton" onclick="cell_edit(this)" value="{% trans 'Ok' %}">
                        <input type="button" id="myCellCancelButton" onclick="edit_cancel(this)" value="{% trans 'Отменить' %}">
                    </form>
                </div>
                <div id="myColumn" style="display: none">
                    <form action="" method="POST" id="form_column">
                        {% csrf_token %}
                        <input type="text" name="inputColumnName" id="inputColumn" placeholder="{% trans 'Введите значение' %}" autofocus>
                        <input type="submit" id="myColumnButton" onclick="column_edit(this)" value="{% trans 'Ok' %}">
                        <input type="button" id="myColumnCancelButton" onclick="edit_cancel(this)" value="{% trans 'Отменить' %}">
                    </form>
                </div>
            </div>

            <div class="table" id="myTable">

                {% for node in ylisttable %}

                    {% if forloop.first %}
                        <div class="th-row">
                            <div class="th-cell"></div>
                            {#                        {% for title in titles %}#}
                            {% for title in columns %}
                                <div class="th-cell" id="th-{{ forloop.counter0 }}" name="th-{{ forloop.counter0 }}">
                                    <img src="{% static 'images/ins_column_above_24.png' %}"
                                         id="insert_col_pre_{{ current_ylist.id }}_{{ forloop.counter0 }}" node_prz="1" node_id=
                                                 "{{ current_ylist.id }}" node_sort="{{ forloop.counter0 }}" onClick="myClick_column_ins(this);"/>
                                    <span onClick="myClick_column_edit(this);" column_id="column-{{ forloop.counter0 }}" pk="{{ current_ylist.id }}"
                                          col="{{ title }}">{{ title }}</span>
                                </div>
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="{% cycle 'row1' 'row2' %}" id="row_{{ forloop.counter }}">
                        <div class="cell">
                            <div class="object-list-buttons">
                                <img src="{% static 'images/ins_row_above_24.png' %}" id="insert_row_pre_{{ forloop.counter }}" node_prz="1"
                                     node_id="{{ forloop.counter }}" node_sort="{{ forloop.counter }}"
                                     onClick="myClick_ins(this);"/> <img src="{% static 'images/ins_row_after_24.png' %}" id="insert_row_after_
{{ forloop.counter }}" node_prz="1" node_id="{{ forloop.counter }}" node_sort="{{ forloop.counter|add:1 }}"
                                                                         onClick="myClick_ins(this);"/>
                                {#                                   <button id="insert_row_pre_{{ forloop.counter }}" node_prz="1" node_id="{{ forloop.counter }}" node_sort="{{ forloop.counter }}"#}
                                {#                                   onClick="myClick_ins(this);">{% trans 'Добавить перед' %}</button>#}
                                <button id="delete_row_{{ forloop.counter }}" node_id="{{ forloop.counter }}"
                                        onClick="myClick_del(this);">{% trans 'Удалить' %}</button>
                            </div>
                        </div>
                        {% for key, value in node.items %}
                            <div class="cell" id="td-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" name="td-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                                 row="{{ forloop.parentloop.counter }}"
                                 column="{{ key }}" val="{{ value }}">{{ value }}</div>
                        {% endfor %}
                    </div>

                {% endfor %}

            </div>
        </div>

        <div id="ajax_itemserror"></div>

        {#        <div style="display: none; position: absolute; top: 22px; left: 26px; width: 290px;" id="myCell_">#}
        {##}
        {#            <form action="" method="POST" id="form_cell">#}
        {#                {% csrf_token %}#}
        {#                <input type="text" name="inputCellName" id="inputCell" placeholder="{% trans 'Введите значение' %}" autofocus>#}
        {#                <input type="submit" id="myCellButton" onclick="cell_edit(this)" value="{% trans 'Ok' %}">#}
        {#            </form>#}
        {##}
        {#        </div>#}

    </div>

    </div>

{% endblock %}


<script>

    document.getElementById('myTable').onclick = function (e) {
        var name = e.target.getAttribute('name');
        var row = e.target.getAttribute('row');
        var column = e.target.getAttribute('column');
        var val = e.target.getAttribute('val');
        var cell_id = e.target.getAttribute('id');
        var inp = document.getElementById("inputCell");
        inp.setAttribute('row', row);
        inp.setAttribute('column', column);
        inp.setAttribute('cell_id', cell_id);
        {#console.log('!==========!' + row + '/' + column + '/' + cell_id + '/' + val);#}
        if (e.target.tagName.toUpperCase() == "DIV") {
            //document.getElementById(e.target.id).innerHTML = "Welcome to JavaScript";
            document.getElementById("myCell").style.display = "block";
            document.getElementById("inputCell").placeholder = val;
            document.getElementById("inputCell").value = val;
            document.getElementById("inputCell").focus();
            document.getElementById("myCell").style.top = (e.clientY-12)+'px';
            document.getElementById("myCell").style.left = (e.clientX-50)+'px';
            {#console.log(name + '/' + document.getElementById("myCell").style.top + '/' + document.getElementById("myCell").style.left);#}
        }
    }

    function cell_edit(e) {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        var elem = document.getElementById("inputCell");
        var row = elem.getAttribute("row");
        var column = elem.getAttribute("column");
        var val = elem.value;
        var cell_id = elem.getAttribute("cell_id");
        console.log(row + '/' + column + '/' + val + '/' + 'cell_id');
        $.ajax({
            url: "{% url 'my_list:yitem_celledit' %}",
            type: "GET",
            data: {
                col: column,
                pk: row,
                val: val
            },
            success: function (data) {
                document.getElementById(cell_id).innerHTML = val;   // выводим значение ячейки без перезагрузки списка
            },
            error: function (xhr, errmsg, err) {
                console.log("error")
                console.log(error_data)
                $('#ajax_itemserror').html('Нет данных!');
            }
        });
        document.getElementById("myCell").style.display = "none";
    }

    function edit_cancel() {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        document.getElementById("myCell").style.display = "none";
    }

    function myClick_ins(e) {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        $.ajax({
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: "{% url 'my_list:yitem_insert' %}",
            type: "GET",
            data: {
                prz: e.getAttribute("node_prz"),
                pk: e.getAttribute("node_id"),
                sort: e.getAttribute("node_sort"),
            },
            success: function (data) {
                $('#ajax_itemsresult').html(data);
            },
            error: function (xhr, errmsg, err) {
                console.log("error")
                console.log(error_data)
                $('#ajax_itemserror').html('Нет данных!');
            }
        });
    }

    function myClick_del(e) {
        if (confirm('Вы действительно хотите удалить строку?')) {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        var node_id = e.getAttribute("node_id")
        $.ajax({
            url: "{% url 'my_list:yitem_delete' %}",
            type: "GET",
            data: {
                pk: node_id,
            },
            success: function (data) {
                {#console.log(data)#}
                console.log("delete_row_"+node_id)
                document.getElementById("row_"+node_id).style.display = "none";
            },
            error: function (xhr, errmsg, err) {
                console.log("error")
                console.log(error_data)
                $('#ajax_itemserror').html('Нет данных!');
            }
        });
        };
    }

    function myClick_column_ins(e) {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        $.ajax({
            headers: { "X-CSRFToken": '{{csrf_token}}' },
            url: "{% url 'my_list:ylist_columninsert' %}",
            type: "GET",
            data: {
                prz: e.getAttribute("node_prz"),
                pk: e.getAttribute("node_id"),
                sort: e.getAttribute("node_sort"),
            },
            success: function (data) {
                var result = data['success']
                console.log(data['success'])
                if (result) {
                    $('#ajax_itemsresult').html(data);
                } else {
                    {#$('#ajax_itemserror').html('Такой столбец уже есть!');#}
                    alert(data['errmsg'])
                }
            },
            error: function (xhr, errmsg, err) {
                console.log("error")
                console.log(error_data)
                $('#ajax_itemserror').html('Такой столбец уже есть!');
            }
        });
    }

    function myClick_column_edit(e) {
        event.preventDefault(); // *** без этого страница перегружается после возврата data
        {#var elem = document.getElementById("inputCell");#}
        var column_id = e.getAttribute("column_id");
        {#var col = elem.getAttribute("col");#}
        {#var val = elem.value;#}
        $.ajax({
            url: "{% url 'my_list:ylist_columnedit' %}",
            type: "GET",
            data: {
                pk: e.getAttribute("pk"),
                col: e.getAttribute("col"),
                val: e.value,
            },
            success: function (data) {
                document.getElementById(column_id).innerHTML = elem.value;   // выводим значение ячейки без перезагрузки списка
            },
            error: function (xhr, errmsg, err) {
                console.log("error")
                console.log(error_data)
                $('#ajax_itemserror').html('Нет данных!');
            }
        });
        document.getElementById("myColumn").style.display = "none";
    }

</script>