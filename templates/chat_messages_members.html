
    <div id="ajax_messagelistresult_" class="object-chats-messages">
        {% include 'chat_messages_list.html' %}
    </div>
    <div id="ajax_messagelisterorr_"></div>

    <div id="ajax_memberlistresult" class="object-chats-members">
        {% include 'chat_members_list.html' %}
    </div>
    <div id="ajax_memberlisterror"></div>

    {% if currentchat %}

    <script>

        // Восстанавливаем стиль шрифта списка чатов
        document.getElementById("chatlist").style.fontWeight = "normal";
        // Подсвечиваем выбранный чат
        //document.querySelector('#chat_{currentchatid}}').innerHTML = ('<b>{ currentchat.name }}</b>');
        document.getElementById("chat_{{currentchatid}}").style.fontWeight = "bolder";
        // Прокручиваем сообщения в чате вниз
        block = document.getElementById("ajax_messagelistresult_");
        block.scrollTop = block.scrollHeight;

        var getMembersOnLine = function() {
            $.ajax( {
                //url: "{ url 'my_chat:messages' %}",
                url: "{% url 'my_chat:ajax_memberlist' %}",
                type: "GET",
                data: {
                    chatid: {{ currentchatid }},
                    //interval: 1,
                },
                success: function(data) {
                        //console.log(data)
                        //$('#ajax_chatlistresult').html(data);
                        //$('#ajax_messagelistresult').html(data);
                        $('#ajax_memberlistresult').html(data);
                       },
                //complete: function() {
                //        setInterval(getMembersOnLine, 1000000);
                //       },
                error: function(xhr, errmsg, err) {
                        console.log("error")
                        //console.log(error_data);
                        //$('#ajax_messagelisterorr').html('Нет данных!');
                        $('#ajax_memberlisterorr').html('Нет данных!');
                       }
            });
        };
/*
        // Вместо этого ajax применяем webSocket'ы
        if (typeof interval !== 'undefined') {
            clearInterval(interval);    // иначе множатся вызовы!!!
        }
        interval = setInterval(getMembersOnLine, 10000);
*/

        try {
            setTimeout(ChatSocket.close(), 10)
            //ChatSocket_{currentchatid}} = null;
            //console.log('Чат ' + {{ currentchatid }} + 'закрыт!');
        } catch(exception) {
            console.log('=== ' + exception);
        }

        ChatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chats/chat/' + {{ currentchatid }} + '/' + {{ request.user.id }} + '/'
        );

        ChatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const mess = data.message;
            //console.log('///'+data.date)
            //console.log('&&&'+data.message)
            if (data.ismemberslist) {     // отображаем список участников чата
                const members = mess.split(';');
                //console.log('-members:'+members)
                for (member of members) {
                    const memb = member.split('/');
                    if (memb[0] !== '') {
                        if (memb[1] === 'True') {
                            document.getElementById("member_" + memb[0]).style.fontWeight = "bolder";
                        } else {
                            console.log('members='+members+'/memb='+memb+'/memb[0]='+memb[0])
                            document.getElementById("member_" + memb[0]).style.fontWeight = "normal";
                        }
                        document.getElementById("member_" + memb[0] + "_date").value = '<i>(=' + memb[2] + '=)</i>';
                    }
                }
            } else {    // отображаем сообщения в чате
                if (data.userfromname === '{{request.user.username}}') {
                    document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
                } else {
                    document.querySelector('#logchat').innerHTML += ('<div class="chat_message"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
                }
                var block = document.getElementById("ajax_messagelistresult_");
                block.scrollTop = block.scrollHeight;
            }
        };

        ChatSocket.onclose = function (e) {
            //const data = JSON.parse(e.data);
            console.error('Chat socket closed unexpectedly!')
        };

        /* Работаем с участниками чата через тот же websocket */

        var chat_send = function() {
        //    ChatSocket.send(JSON.stringify("heartbeat"));
             let today = new Date();
             now = today.toLocaleString()
             ChatSocket.send(JSON.stringify({
                    'chatid': {{ currentchatid }},
                    'userfromid': '{{ request.user.id }}',
                    'userfromname': '{{ request.user.username }}',
                    'message': '2. проверка пользователей',
                    'date': now,
                    'ismemberslist': true
             }));
        }

        if (ChatSocket.readyState === WebSocket.OPEN) {
            window.chat_send();
        } else {
            setTimeout(chat_send, 1000);
        }

        if (typeof interval2 !== 'undefined') {
            clearInterval(interval2);    // иначе множатся вызовы!!!
        }
        interval2 = setInterval(chat_send, 30000);

    </script>

    {% endif %}