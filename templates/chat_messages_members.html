
    <div id="ajax_messagelistresult_" class="object-chats-messages">
        {% include 'chat_messages_list.html' %}
    </div>
    <div id="ajax_messagelisterorr_"></div>

    <div id="ajax_memberlistresult" class="object-chats-members">
        {% include 'chat_members_list.html' %}
    </div>
    <div id="ajax_memberlisterror"></div>

    {% if currentchat %}

    <script>

        // Восстанавливаем стиль шрифта списка чатов
        document.getElementById("chatlist").style.fontWeight = "normal";
        // Подсвечиваем выбранный чат
        //document.querySelector('#chat_{currentchatid}}').innerHTML = ('<b>{ currentchat.name }}</b>');
        document.getElementById("chat_{{currentchatid}}").style.fontWeight = "bolder";
        // Прокручиваем сообщения в чате вниз
        block = document.getElementById("ajax_messagelistresult_");
        block.scrollTop = block.scrollHeight;

        var getMembersOnLine = function() {
            $.ajax( {
                //url: "{ url 'my_chat:messages' %}",
                url: "{% url 'my_chat:ajax_memberlist' %}",
                type: "GET",
                data: {
                    chatid: {{ currentchatid }},
                    //interval: 1,
                },
                success: function(data) {
                        //console.log(data)
                        //$('#ajax_chatlistresult').html(data);
                        //$('#ajax_messagelistresult').html(data);
                        $('#ajax_memberlistresult').html(data);
                       },
                //complete: function() {
                //        setInterval(getMembersOnLine, 1000000);
                //       },
                error: function(xhr, errmsg, err) {
                        console.log("error")
                        //console.log(error_data);
                        //$('#ajax_messagelisterorr').html('Нет данных!');
                        $('#ajax_memberlisterorr').html('Нет данных!');
                       }
            });
        };
/*
        if (typeof interval !== 'undefined') {
            clearInterval(interval);    // иначе множатся вызовы!!!
        }
        interval = setInterval(getMembersOnLine, 10000);
*/

        try {
            setTimeout(ChatSocket.close(), 1)
            //ChatSocket_{currentchatid}} = null;
        } catch(exception) {
            console.log('=== ' + exception);
        }

        ChatSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chats/chat/' + {{ currentchatid }} + '/' + {{ request.user.id }} + '/'
        );

        ChatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            const mess = data.message;
            //console.log('///'+data.date)
            //console.log('&&&'+data.message)
            if (data.ismemberslist) {     // отображаем список участников чата
                //document.querySelector('#logmembers').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date +
                //    '</i><br />' + data.message + '</div><br />');
                const members = mess.split(';');
                //console.log('-members:'+members)
                for (member of members) {
                    const memb = member.split('/');
                    var i = 0;
                    //console.log('--memb:'+memb)
                    for (m of memb) {
                        i ++;
                        if (i == 1) {
                            mb = m;
                        } else if (i == 2) {
                                //document.querySelector('#logmembers').innerHTML += ('<div class="chat_message_my">' + member + "|" + i + "|" + mb +
                                //'</div><br ' + '/>');
                            if (m == 'True') {
                                document.getElementById("member_" + mb).style.fontWeight = "bolder";
                            } else {
                                document.getElementById("member_" + mb).style.fontWeight = "normal";
                            }
                        } else {
                            //document.getElementById("member_" + mb+ "_date").value = '<i>(=' + m + '=)</i>';
                            //console.log(m)
                        }
                        //console.log('---mb:'+i+'.'+mb)
                    }
                }
            } else {    // отображаем сообщения в чате
                if (data.userfromname === '{{request.user.username}}') {
                    document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
                } else {
                    document.querySelector('#logchat').innerHTML += ('<div class="chat_message"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
                }
                var block = document.getElementById("ajax_messagelistresult_");
                block.scrollTop = block.scrollHeight;
            }
        };

        ChatSocket.onclose = function (e) {
            //const data = JSON.parse(e.data);
            console.error('Chat socket closed unexpectedly!')
        };

        /* Работаем с участниками чата через websocket */
    {% comment %}
        try {
            setTimeout(ChatMemberSocket.close(), 1)
        } catch(exception) {
            console.log('ChatMemberSocket: ' + exception);
        }
        //setTimeout(ChatMemberSocket.close(), 1)

        ChatMemberSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/chats/chat/member/' + {{ currentchatid }} + '/' + {{ request.user.id }} + '/'
        );

        ChatMemberSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            //console.log('///'+data.date)
            console.log('&&&'+data.message)
            document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my">Пользователь <b>' + data.userfromid + '</b> вошёл в чат! <i>' +
                data.date + '</i><br ' + '/>' + data.message + '</div><br />');
            //if (data.userfromname === '{request.user.username}}') {
            //    document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
            //} else {
            //    document.querySelector('#logchat').innerHTML += ('<div class="chat_message"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
            //}
            //var block = document.getElementById("ajax_messagelistresult_");
            //block.scrollTop = block.scrollHeight;

            //if (data.member_isonline) {
            //    document.querySelector('#member_{request.user.id}}').innerHTML = ('===<b>data.userfromname</b>');
            //} else {
            //    document.querySelector('#member_{request.user.id}}').innerHTML = ('data.userfromname');
            //}
            //document.querySelector('#logchat').innerHTML += ('=============================')
        };

        ChatMemberSocket.onclose = function (e) {
            //const data = JSON.parse(e.data);
            console.error('ChatMember socket closed unexpectedly!' + e.code)
        };
    /*
        ChatMemberSocket.send(JSON.stringify({'chatid': {{currentchatid}},
                                              'userfromid': '{{ request.user.id }}',
                                              'userfromname': '{{ request.user.username }}',
                                              'message': 'хе-хе',
                                              'date': now}))
    */
        setInterval(function() {
            ChatMemberSocket.send(JSON.stringify("heartbeat"));
        }, 30000);
    {% endcomment %}

        /* Работаем с участниками чата через тот же websocket */

        if (typeof interval2 !== 'undefined') {
            clearInterval(interval2);    // иначе множатся вызовы!!!
        }

        interval2 = setInterval(function() {
        //    ChatSocket.send(JSON.stringify("heartbeat"));
             let today = new Date();
             now = today.toLocaleString()
             ChatSocket.send(JSON.stringify({
                    'chatid': {{currentchatid}},
                    'userfromid': '{{ request.user.id }}',
                    'userfromname': '{{ request.user.username }}',
                    'message': '2. проверка пользователей',
                    'date': now,
                    'ismemberslist': true
             }));
        }, 30000);

    </script>

    {% endif %}