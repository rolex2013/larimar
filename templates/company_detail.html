{% extends 'base.html' %}

<!--{% load bootstrap4 %}-->

{% block company %}
   
   <!-- Защита от прямого доступа к компании -->
   {% if current_company.id in user_companies %}

     <div class="company-entry">
        <h2>{{ current_company.name }}
        {% if not current_company.is_active %}(Организация перемещена в архив){% endif %}
        </h2>
        <p>{% autoescape off %} {{ current_company.description }}{% endautoescape %}</p>

        {% if current_company.parent.pk %}
           <i><p>Организация: 
           <!--<a href="{ url 'my_project:companies' current_company.parent.pk %}">{{ current_company.parent.name }}</a>-->
           <a href="{% url 'my_project:projects' current_company.parent.pk 0 %}">{{ current_company.parent.name }}</a>
           </p></i>
        <!--{ else %}
           Это головная организация-->
        {% endif %}

        <p>Тип в оргструктуре: {{ current_company.structure_type }}</p>
        <p>Тип: {{ current_company.type }}</p>
        <em>Автор: {{ current_company.author }}</em><br /> 
        <em>Дата: {{ current_company.datecreate }}</em>
        <br /><br />
        <!--{ if user.is_authenticated and user.id == current_company.author_id  %}-->
           <div>
              <!--<div style="float: left;" class="task-entry"><a href="{ url 'my_company:company_create' current_company.pk %}" class="top-menu"><span class="badge badge-secondary">Добавить</span></a></div>-->
              <div style="float: left;" class="task-entry"><a href="{% url 'my_company:menu_companies' %}" class="top-menu"><span class="badge badge-secondary">{{ button_company_select }}</span></a></div>
              <div style="float: left;">&nbsp;</div><div style="float: left;">&nbsp;</div>
              <div style="float: left;" class="task-entry"><a href="{% url 'my_company:company_create' current_company.pk %}" class="top-menu"><span class="badge badge-secondary">{{ button_company_create }}</span></a></div>
              <div style="float: left;">&nbsp;</div><div style="float: left;">&nbsp;</div>
              <div style="float: left;" class="task-entry"><a href="{% url 'my_company:company_update' current_company.pk %}" class="top-menu"><span class="badge badge-secondary">{{ button_company_update }}</span></a></div>
           </div>
        <!--{ endif %}-->
     </div>
     <br /><br />

   {% else %}

     <h4>Информация об организации недоступна!</h4> <!--{ current_company.id }}/{ user_companies }}-->

   {% endif %}  

{% endblock company %}

{% block list %}

   <!-- Защита от прямого доступа к проектам компании -->
   {% if current_company.id in user_companies %}

      <div class="project-list">
         <h3>Список Проектов</h3>  

         <!--<form action="{% url 'my_project:projects' current_company.pk 0 %}" method="post">-->
         <form method="GET">
            {% csrf_token %}
            <!--<label for="">Введите название установки</label><br/>
            <input name="search" type="text">-->
            <label>Фильтр по статусу: </label>
            <select name="select-projectstatus" id="selectid"  class="select-project-status">
               <option value="-1" {% ifequal "-1" prjstatus_selectid %} selected="selected" {% endifequal %}>- Все</option>
               <option value="0" {% ifequal 0 prjstatus_selectid|add:"0" %} selected="selected" {% endifequal %}>- Все активные</option>
               <option value="-2" {% ifequal "-2" prjstatus_selectid %} selected="selected" {% endifequal %}>- Просроченные</option>   
               {% for prjstatus in projectstatus %}
                  <option value="{{prjstatus.id}}" {% ifequal prjstatus.id prjstatus_selectid|add:"0" %} selected="selected" {% endifequal %}>
                     {{prjstatus.name}}
                  </option>   
               {% endfor %}
            </select>
            <!--<button id="selection-button" type="submit" method="GET">Применить</button>
            <input type="button" value="Применить" id="selection-button" method="GET">-->
            <!--<div class="project-entry"><a href="{ url 'my_project:projects' current_company.pk 0 %}" class="top-menu">
            <span class="badge badge-secondary">Все</span></a></div>-->
         </form>

         <div id="ajax_listresult">{% include 'objects_list.html' %}</div>
         <div id="ajax_listerrors"></div>

      <!--{ endif %}-->
         <!--<div class="project-entry"><a href="{ url 'my_project:project_create' companyid 0 %}" class="top-menu"><span class="badge badge-secondary">Добавить</span></a></div>-->
         <div class="project-entry"><a href="{% url 'my_project:project_create' companyid 0 %}" class="top-menu"><span class="badge badge-secondary">{{ button_project_create }}</span></a></div>
      </div>

      <br /><br />

      <script>
  
         //$("#selection-button").on('click',function(){
         $(document).on('change', '.select-project-status', function() {
            //console.log(this.value);
            //console.log(this.text);
            //$('.projects_list').html('').load("{ url 'my_project:project_filter' 8 %}" /*+ this.value*/);
            //var statusSelected = $('#select-projectstatus').find(":selected").val();   
            //var statusSelected = document.getElementById('selectid').value; 
            var statusSelected = $(this).val(); 
            //console.log(statusSelected);            
            $.ajax({
                 url: "{% url 'my_project:project_filter' %}",
                 method: 'GET',
                 data : {
                         //filter_category: parseInt(statusSelected)
                         companyid: {{ current_company.id }},
                         projectstatus: statusSelected
                        },
                 success: function(data) 
                        {
                         //console.log(data)
                         $('#ajax_listresult').html(data);
                        },
                 error: function(xhr, errmsg, err) 
                        {
                         console.log("error")
                         console.log(error_data)
                         $('#ajax_listerrors').html('Нет данных!');
                        }
             });            
         });         

         /*
         $("#selectionbutton").keyup(function(){
            console.log(this.value);
            $('.projects_list').html('').load("{ url 'my_project:project_filter' %}" /+ this.value/);
         });
            
         $("#selectionbutton" ).click(function(event) {
             event.preventDefault();
             var statusSelected = $('#select-projectstatus').find(":selected").val();
             console.log($('#select-projectstatus').find(":selected").val());
          
             $.ajax({
                 url: "{ url 'my_project:project_filter' %}",
                 method: 'GET',
                 data : {
                         filter_category: parseInt(statusSelected)
                        },
                 success: function(data) 
                        {
                         console.log(data)
                        },
                 error: function(xhr, errmsg, err) 
                        {
                         console.log("error")
                         console.log(error_data)
                        }
             });
         });
         */

      </script>

   {% else %}

      <h5>Информация о проектах недоступна!</h5>

   {% endif %}  

{% endblock list %}

