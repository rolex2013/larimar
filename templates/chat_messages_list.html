
            {% if currentchat %}

                <h4>#{{ currentchat.company_id }}.{{ currentchatid }}. {{ currentchat.name }}</h4>
                <h5>{{ currentchat.description }}</h5>

                {% for node in nodes_messages %}
                    {% if node.author_id == request.user.id %}
                        <div class="chat_message_my">
                    {% else %}
                        <div class="chat_message">
                    {% endif %}
                    <b>{{ node.author }}</b> <i>{{ node.datecreate | date:"d.m.Y H:i:s" }}</i><br />{% autoescape off %}{{ node.text }}{% endautoescape %}
                    </div>
                    <br />
                {% endfor %}

                <p id="logchat" style="font-size: small;"></p>

<script>

    try {
        setTimeout(ChatSocket.close(), 1)
        //ChatSocket_{currentchatid}} = null;
    } catch(exception) {
        console.log('=== ' + exception);
    }

    ChatSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chats/chat/' + {{ currentchatid }} + '/' + {{ request.user.id }} + '/'
    );

    ChatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        //console.log('///'+data.date)
        //console.log('&&&'+data.message)
        if (data.userfromname === '{{request.user.username}}') {
            document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
        } else {
            document.querySelector('#logchat').innerHTML += ('<div class="chat_message"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
        }
        var block = document.getElementById("ajax_messagelistresult_");
        block.scrollTop = block.scrollHeight;
    };

    ChatSocket.onclose = function (e) {
        //const data = JSON.parse(e.data);
        console.error('Chat socket closed unexpectedly!')
    };

    /* Работаем с участниками чата через websocket */

    try {
        setTimeout(ChatMemberSocket.close(), 1)
    } catch(exception) {
        console.log('ChatMemberSocket: ' + exception);
    }
    //setTimeout(ChatMemberSocket.close(), 1)
    ChatMemberSocket = new WebSocket(
        'ws://'
        + window.location.host
        + '/ws/chats/chat/member/' + {{ currentchatid }} + '/' + {{ request.user.id }} + '/'
    );

    ChatMemberSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        //console.log('///'+data.date)
        //console.log('&&&'+data.message)
        document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my">Пользователь <b>' + data.username + '</b> вошёл в чат! <i>' +
            data.date + '</i><br ' + '/>' + data.message + '</div><br />');
        //if (data.userfromname === '{request.user.username}}') {
        //    document.querySelector('#logchat').innerHTML += ('<div class="chat_message_my"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
        //} else {
        //    document.querySelector('#logchat').innerHTML += ('<div class="chat_message"><b>' + data.userfromname + '</b> <i>' + data.date + '</i><br />' + data.message + '</div><br />');
        //}
        //var block = document.getElementById("ajax_messagelistresult_");
        //block.scrollTop = block.scrollHeight;

        //if (data.member_isonline) {
        //    document.querySelector('#member_{request.user.id}}').innerHTML = ('===<b>data.userfromname</b>');
        //} else {
        //    document.querySelector('#member_{request.user.id}}').innerHTML = ('data.userfromname');
        //}
        //document.querySelector('#logchat').innerHTML += ('=============================')
    };

    ChatMemberSocket.onclose = function (e) {
        //const data = JSON.parse(e.data);
        console.error('ChatMember socket closed unexpectedly!' + e.code)
    };

    setInterval(function() {
        ChatMemberSocket.send(JSON.stringify("heartbeat"));
    }, 30000);


</script>

            {% endif %}