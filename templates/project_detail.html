{% extends 'base.html' %}

{% block project %}
   <!-- Защита от прямого доступа к проекту -->
   {% if current_project.company.id in user_companies %}

     <div class="project-entry">
       <p><h2>{{ current_project.name }}
       {% if not current_project.is_active %}
          (Проект перемещён в архив)
       {% endif %}
       </h2></p>
       <p>{% autoescape off %}{{ current_project.description }}{% endautoescape %}</p>
       <i><p>Организация: <a href="{% url 'my_project:projects' current_project.company.pk 0 %}">{{ current_project.company }}</a></p></i>
       {% if current_project.parent %}
          <p>Уровень выше: <a href="{% url 'my_project:tasks' current_project.parent.pk 0 %}">{{ current_project.parent.name }}</a></p>
       {% else %}
          <!-- <p>: <a href="{ url 'my_project:projects' current_project.company.pk current_project.parent.pk %}">{{ current_project.parent.name }}</a></p>-->
       {% endif %}
       <p>Бюджет: {{ current_project.cost }}</p>
       <p>Исполнитель: {{ current_project.assigner }}</p>     
       <p>Начало: {{ current_project.datebegin }}</p>
       <p>Окончание: {{ current_project.dateend }}</p>
       <p>Тип в иерархии: {{ current_project.structure_type }}</p>
       <p>Тип: {{ current_project.type }}</p>
       <p>Статус: {{ current_project.status }}</p>
       <p>Выполнен на: {{ current_project.percentage }} %</p>
       <p><i>Участники: 
       {% for u in current_project.members.all %}
          <span class="hint hint--bottom hint--info" data-hint="Профиль"><a href="{% url 'my_account:userprofile_detail' u.pk ' ' %}">{{ u.username }}</a>,</span>&nbsp;
       {% endfor %}
       </i></p>
       <em>Автор: {{ current_project.author }}</em><br /> 
       <!--<em>Участники: { current_project.members.name }}</em><br /> -->
       <em>Дата: {{ current_project.datecreate }}</em>
       <p>&nbsp;</p>
       <!--{ if user.is_authenticated and user.id == current_project.author_id  %}-->
         <div>
           <div style="float: left;"><a href="{% url 'my_project:project_create' current_project.company.id current_project.pk %}" class="top-menu"><span class="badge badge-secondary">{{ button_project_create }}</span></a></div>
           <div style="float: left;">&nbsp;</div><div style="float: left;">&nbsp;</div>
           <div style="float: left;"><a href="{% url 'my_project:project_update' current_project.pk %}" class="top-menu"><span class="badge badge-secondary">{{ button_project_update }}</span></a></div>
           <div style="float: left;">&nbsp;</div><div style="float: left;">&nbsp;</div>
           <!--<div style="float: left;"><a href="{ url 'my_project:project_delete' project.pk %}" class="top-menu"><span class="badge badge-secondary">Удалить</span></a></div> -->
           <div style="float: left;"><a href="{% url 'my_project:project_history' current_project.pk %}" class="top-menu"><span class="badge badge-secondary">{{ button_project_history }}</span></a></div>
         </div>
       <!--{ endif %}-->
     </div>
     <br /><br />

  {% else %}
     <h4>Информация о проекте недоступна!</h4> <!--{ current_company.id }}/{ user_companies }}-->
  {% endif %}  

{% endblock project %}

{% block list %}
   <!-- Защита от прямого доступа к задачам проекта -->
   {% if current_project.company.id in user_companies %}

      <div class="task-list">
        <h3>Список Задач</h3>

         <!--<form action="{ url 'my_project:tasks' current_project.pk 0 %}" method="post">-->
         <form method="GET">           
            {% csrf_token %}
            <label>Фильтр по статусу: </label>
            <select name="select_taskstatus" id="selectid"  class="select-task-status">
               <option value="-1" {% ifequal "-1" tskstatus_selectid %} selected="selected" {% endifequal %}>- Все</option>
               <option value="0" {% ifequal 0 tskstatus_selectid|add:"0" %} selected="selected" {% endifequal %}>- Все активные</option> 
               <option value="-2" {% ifequal "-2" tskstatus_selectid %} selected="selected" {% endifequal %}>- Просроченные</option>                    
               {% for tskstatus in taskstatus %}
                  <option value="{{tskstatus.id}}" {% ifequal tskstatus.id tskstatus_selectid|add:"0" %} selected="selected" {% endifequal %}>
                     {{tskstatus.name}}
                  </option>   
               {% endfor %}
            </select>
            <!--<button type="submit">Применить</button>-->
         </form>

         <div id="ajax_listresult">{% include 'objects_list.html' %}</div>

<!--
        { load mptt_tags %}
    
        <ul>
          { recursetree nodes %}
             <!-{ ifequal node.project_id projectid %}->
                { if user.is_authenticated and node.is_active %}
                   <li> 
                     <b><a href="{ url 'my_project:task_detail' node.pk %}">
                     <!- <a href="{ url 'my_project:tasks' current_project.id node.pk %}">->
                     { node.name }}</a> : <span style="font-size: 70%; color: brown;">{ node.datebegin }} - { node.dateend }} | 
                        { node.status.name }} | 
                        <span class="hint hint--bottom hint--info" data-hint="Профиль"><a style="color: brown;" href="{ url 'my_account:userprofile_detail' node.author.pk ' ' %}"><i>{ node.author.username }}</i></a></span> | 
                        { node.cost }}</span></b>
                     { if not node.is_leaf_node %}
                        <ul class="children">
                           { children }}
                        </ul>
                     { endif %}
                   </li>
                { endif %}
             <!-{ endifequal %}->
          { endrecursetree %}
        </ul>    
-->
      </div>

   <!--<a href="{ url 'my_project:task_create' project.pk %}" class="top-menu"><span class="glyphicon glyphicon-plus"></span></a>-->
   <div class="task-entry"></div><a href="{% url 'my_project:task_create' projectid 0 %}" class="top-menu"><span class="badge badge-secondary">{{ button_task_create }}</span></a></div>

   <br /><br />

   <script>
  
      $(document).on('change', '.select-task-status', function() {
         var statusSelected = $(this).val(); 
         //console.log(statusSelected);            
         $.ajax({
              url: "{% url 'my_project:task_filter' %}",
              method: 'GET',
              data : {
                      projectid: {{ current_project.id }},
                      taskstatus: statusSelected
                     },
              success: function(data) 
                     {
                      //console.log(data)
                      $('#ajax_listresult').html(data);
                     },
              error: function(xhr, errmsg, err) 
                     {
                      console.log("error")
                      console.log(error_data)
                     }
          });            
      });         

   </script>

   {% else %}
      <h5>Информация о задачах недоступна!</h5>
   {% endif %}  

   {% endblock list %}